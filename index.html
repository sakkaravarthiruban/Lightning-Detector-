<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HV Safety Monitoring Dashboard | Control Center</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ... (keep all previous CSS styles) ... */

/* Add these new styles for the chart section */

.chart-container {
  background: var(--white);
  border-radius: 16px;
  border: 1px solid var(--gray-200);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
  padding: 30px;
  margin-bottom: 40px;
}

.chart-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 25px;
}

.chart-header h3 {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--gray-900);
  display: flex;
  align-items: center;
  gap: 12px;
}

.chart-controls {
  display: flex;
  gap: 15px;
  align-items: center;
}

.chart-controls select {
  padding: 10px 16px;
  border-radius: 10px;
  border: 1px solid var(--gray-300);
  background: var(--white);
  color: var(--gray-700);
  font-family: inherit;
  font-weight: 500;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.chart-controls select:hover {
  border-color: var(--primary-500);
}

.chart-wrapper {
  position: relative;
  height: 350px;
  width: 100%;
}

.chart-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-top: 25px;
  padding: 20px;
  background: var(--gray-50);
  border-radius: 12px;
  border: 1px solid var(--gray-200);
}

.chart-stat-item {
  text-align: center;
}

.chart-stat-value {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--primary-700);
  margin-bottom: 5px;
}

.chart-stat-label {
  font-size: 0.9rem;
  color: var(--gray-600);
  font-weight: 500;
}

.chart-stat-item.critical .chart-stat-value {
  color: var(--danger-600);
}

.chart-stat-item.warning .chart-stat-value {
  color: var(--warning-600);
}

.chart-stat-item.success .chart-stat-value {
  color: var(--success-600);
}

.loading-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
  z-index: 10;
}

/* Time range buttons */
.time-range-buttons {
  display: flex;
  gap: 8px;
  background: var(--gray-100);
  padding: 4px;
  border-radius: 10px;
}

.time-range-btn {
  padding: 8px 16px;
  border: none;
  background: transparent;
  border-radius: 8px;
  font-family: inherit;
  font-weight: 500;
  font-size: 0.85rem;
  color: var(--gray-600);
  cursor: pointer;
  transition: all 0.3s ease;
}

.time-range-btn:hover {
  background: var(--gray-200);
  color: var(--gray-700);
}

.time-range-btn.active {
  background: var(--primary-600);
  color: var(--white);
  box-shadow: 0 2px 8px rgba(2, 132, 199, 0.3);
}

/* Legend styles */
.chart-legend {
  display: flex;
  justify-content: center;
  gap: 25px;
  margin-top: 20px;
  flex-wrap: wrap;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.85rem;
  color: var(--gray-700);
}

.legend-color {
  width: 12px;
  height: 12px;
  border-radius: 2px;
}

/* Responsive chart */
@media (max-width: 768px) {
  .chart-wrapper {
    height: 300px;
  }
  
  .chart-stats {
    grid-template-columns: 1fr;
  }
  
  .chart-controls {
    flex-direction: column;
    align-items: stretch;
  }
  
  .time-range-buttons {
    justify-content: center;
  }
}
</style>
</head>

<body>

<!-- ... (keep all previous HTML structure) ... -->

  <!-- ===== CHART SECTION ===== -->
  <div class="chart-container fade-in" style="animation-delay: 0.2s">
    <div class="chart-header">
      <h3>
        <i class="fas fa-chart-line"></i>
        Fault Trends Analysis
      </h3>
      <div class="chart-controls">
        <div class="time-range-buttons">
          <button class="time-range-btn" data-days="7" onclick="changeTimeRange(7)">7D</button>
          <button class="time-range-btn active" data-days="30" onclick="changeTimeRange(30)">30D</button>
          <button class="time-range-btn" data-days="90" onclick="changeTimeRange(90)">90D</button>
        </div>
        <select onchange="changeChartType(this)">
          <option value="line">Line Chart</option>
          <option value="bar">Bar Chart</option>
          <option value="area">Area Chart</option>
        </select>
      </div>
    </div>
    
    <div class="chart-wrapper">
      <canvas id="faultTrendChart"></canvas>
      <div class="loading-overlay" id="chartLoading" style="display: none;">
        <div class="text-center">
          <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
          <div>Loading chart data...</div>
        </div>
      </div>
    </div>
    
    <div class="chart-legend" id="chartLegend">
      <!-- Legend will be generated by JavaScript -->
    </div>
    
    <div class="chart-stats">
      <div class="chart-stat-item critical">
        <div class="chart-stat-value" id="criticalFaults">0</div>
        <div class="chart-stat-label">Critical Faults</div>
      </div>
      <div class="chart-stat-item warning">
        <div class="chart-stat-value" id="warningFaults">0</div>
        <div class="chart-stat-label">Warning Faults</div>
      </div>
      <div class="chart-stat-item">
        <div class="chart-stat-value" id="totalFaultsChart">0</div>
        <div class="chart-stat-label">Total Faults</div>
      </div>
      <div class="chart-stat-item success">
        <div class="chart-stat-value" id="avgResolution">4.2h</div>
        <div class="chart-stat-label">Avg. Resolution Time</div>
      </div>
    </div>
  </div>
  
</main>

<!-- ===== FOOTER ===== -->
<footer class="footer">
  <div class="footer-info">
    <span>HV Safety Monitoring System • Enterprise Edition</span>
    <span class="version">v2.5</span>
    <span>© 2024 EnergyTech Systems</span>
  </div>
  
  <div class="footer-links">
    <a href="#"><i class="fas fa-question-circle"></i> Help</a>
    <a href="#"><i class="fas fa-book"></i> Docs</a>
    <a href="#" onclick="openSettings()"><i class="fas fa-cog"></i> Settings</a>
  </div>
</footer>

<!-- ===== FIREBASE INTEGRATION ===== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  databaseURL: "https://lightning-detection-aaa-default-rtdb.asia-southeast1.firebasedatabase.app/"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Chart.js Variables
let faultChart = null;
let currentTimeRange = 30; // days
let chartType = 'line';
let faultData = {
  labels: [],
  critical: [],
  warning: [],
  normal: []
};

// Initialize Chart
function initializeChart() {
  const ctx = document.getElementById('faultTrendChart').getContext('2d');
  
  // Destroy existing chart if it exists
  if (faultChart) {
    faultChart.destroy();
  }
  
  // Generate sample data for the selected time range
  generateChartData();
  
  // Chart configuration
  const chartConfig = {
    type: chartType,
    data: {
      labels: faultData.labels,
      datasets: [
        {
          label: 'Critical Faults',
          data: faultData.critical,
          borderColor: getComputedStyle(document.documentElement).getPropertyValue('--danger-500').trim(),
          backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--danger-100').trim(),
          borderWidth: 2,
          fill: chartType === 'area',
          tension: 0.4
        },
        {
          label: 'Warning Faults',
          data: faultData.warning,
          borderColor: getComputedStyle(document.documentElement).getPropertyValue('--warning-500').trim(),
          backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--warning-100').trim(),
          borderWidth: 2,
          fill: chartType === 'area',
          tension: 0.4
        },
        {
          label: 'Normal Operations',
          data: faultData.normal,
          borderColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-500').trim(),
          backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-100').trim(),
          borderWidth: 2,
          fill: chartType === 'area',
          tension: 0.4
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false // We'll use custom legend
        },
        tooltip: {
          mode: 'index',
          intersect: false,
          backgroundColor: 'rgba(15, 23, 42, 0.9)',
          titleColor: '#f1f5f9',
          bodyColor: '#f1f5f9',
          borderColor: '#475569',
          borderWidth: 1,
          padding: 12,
          callbacks: {
            label: function(context) {
              let label = context.dataset.label || '';
              if (label) {
                label += ': ';
              }
              if (context.parsed.y !== null) {
                label += context.parsed.y + ' faults';
              }
              return label;
            }
          }
        }
      },
      scales: {
        x: {
          grid: {
            color: 'rgba(203, 213, 225, 0.3)'
          },
          ticks: {
            color: '#64748b',
            maxTicksLimit: 10
          }
        },
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(203, 213, 225, 0.3)'
          },
          ticks: {
            color: '#64748b',
            precision: 0,
            callback: function(value) {
              if (value === 0) return '0';
              return value;
            }
          },
          title: {
            display: true,
            text: 'Number of Faults',
            color: '#64748b',
            font: {
              size: 12,
              weight: '500'
            }
          }
        }
      },
      interaction: {
        intersect: false,
        mode: 'nearest'
      },
      animation: {
        duration: 1000,
        easing: 'easeOutQuart'
      }
    }
  };
  
  // Create chart
  faultChart = new Chart(ctx, chartConfig);
  
  // Update legend
  updateChartLegend();
  
  // Update stats
  updateChartStats();
}

// Generate sample chart data based on time range
function generateChartData() {
  const days = currentTimeRange;
  faultData.labels = [];
  faultData.critical = [];
  faultData.warning = [];
  faultData.normal = [];
  
  // Generate dates for the selected time range
  const today = new Date();
  for (let i = days - 1; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(date.getDate() - i);
    
    // Format label based on time range
    let label;
    if (days <= 30) {
      label = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    } else {
      label = date.toLocaleDateString('en-US', { month: 'short' });
    }
    
    faultData.labels.push(label);
    
    // Generate realistic fault data with some randomness
    const baseCritical = Math.floor(Math.random() * 3);
    const baseWarning = Math.floor(Math.random() * 5);
    const baseNormal = 24 - baseCritical - baseWarning; // Assuming 24 operations per day
    
    // Add some trends - more faults on weekdays
    const dayOfWeek = date.getDay();
    const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;
    const multiplier = isWeekday ? 1.5 : 0.8;
    
    faultData.critical.push(Math.max(0, Math.floor(baseCritical * multiplier + Math.random() * 2)));
    faultData.warning.push(Math.max(0, Math.floor(baseWarning * multiplier + Math.random() * 3)));
    faultData.normal.push(Math.max(0, Math.floor(baseNormal * multiplier)));
  }
}

// Update chart legend
function updateChartLegend() {
  const legendContainer = document.getElementById('chartLegend');
  const datasets = faultChart.data.datasets;
  
  let legendHtml = '';
  datasets.forEach((dataset, index) => {
    let color = dataset.borderColor || dataset.backgroundColor;
    if (color.startsWith('rgb')) {
      // Convert RGB to hex for display
      const rgb = color.match(/\d+/g);
      if (rgb) {
        color = `#${rgb.map(x => (+x).toString(16).padStart(2, '0')).join('')}`;
      }
    }
    
    legendHtml += `
      <div class="legend-item">
        <div class="legend-color" style="background-color: ${dataset.borderColor || dataset.backgroundColor}"></div>
        <span>${dataset.label}</span>
      </div>
    `;
  });
  
  legendContainer.innerHTML = legendHtml;
}

// Update chart statistics
function updateChartStats() {
  const totalCritical = faultData.critical.reduce((a, b) => a + b, 0);
  const totalWarning = faultData.warning.reduce((a, b) => a + b, 0);
  const totalFaults = totalCritical + totalWarning;
  
  document.getElementById('criticalFaults').textContent = totalCritical;
  document.getElementById('warningFaults').textContent = totalWarning;
  document.getElementById('totalFaultsChart').textContent = totalFaults;
  
  // Calculate average resolution time (simulated)
  const avgHours = totalFaults > 0 ? (4.2 - (totalCritical * 0.1)).toFixed(1) : '0.0';
  document.getElementById('avgResolution').textContent = `${avgHours}h`;
}

// Change time range
function changeTimeRange(days) {
  currentTimeRange = days;
  
  // Update active button
  document.querySelectorAll('.time-range-btn').forEach(btn => {
    btn.classList.remove('active');
    if (parseInt(btn.getAttribute('data-days')) === days) {
      btn.classList.add('active');
    }
  });
  
  // Show loading
  document.getElementById('chartLoading').style.display = 'flex';
  
  // Simulate data loading
  setTimeout(() => {
    generateChartData();
    faultChart.data.labels = faultData.labels;
    faultChart.data.datasets[0].data = faultData.critical;
    faultChart.data.datasets[1].data = faultData.warning;
    faultChart.data.datasets[2].data = faultData.normal;
    faultChart.update();
    
    updateChartLegend();
    updateChartStats();
    
    // Hide loading
    document.getElementById('chartLoading').style.display = 'none';
  }, 500);
}

// Change chart type
function changeChartType(select) {
  chartType = select.value;
  faultChart.config.type = chartType;
  
  // Update fill property for area charts
  faultChart.data.datasets.forEach(dataset => {
    dataset.fill = chartType === 'area';
  });
  
  faultChart.update();
  updateChartLegend();
}

// Simulate real-time updates to the chart
function simulateRealTimeUpdate() {
  if (!faultChart || faultData.labels.length === 0) return;
  
  // Only update 20% of the time
  if (Math.random() > 0.8) {
    // Get current date for label
    const today = new Date();
    let label;
    if (currentTimeRange <= 30) {
      label = today.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    } else {
      label = today.toLocaleDateString('en-US', { month: 'short' });
    }
    
    // Check if we already have today's data
    const todayIndex = faultData.labels.length - 1;
    if (faultData.labels[todayIndex] === label) {
      // Update today's data
      faultData.critical[todayIndex] += Math.random() > 0.7 ? 1 : 0;
      faultData.warning[todayIndex] += Math.random() > 0.8 ? 1 : 0;
      
      // Update chart
      faultChart.data.datasets[0].data = faultData.critical;
      faultChart.data.datasets[1].data = faultData.warning;
      faultChart.update('none');
      
      // Update stats
      updateChartStats();
    }
  }
}

// ... (keep all previous JavaScript code for time, connection status, etc.) ...

// Initialize chart when page loads
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(() => {
    initializeChart();
    
    // Set up real-time updates
    setInterval(simulateRealTimeUpdate, 10000); // Update every 10 seconds
    
    // Initial stats update
    updateChartStats();
  }, 1000);
});

// Utility functions
function exportData() {
  const data = {
    labels: faultData.labels,
    critical: faultData.critical,
    warning: faultData.warning,
    normal: faultData.normal,
    timeframe: `${currentTimeRange} days`,
    exportedAt: new Date().toISOString()
  };
  
  const dataStr = JSON.stringify(data, null, 2);
  const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
  
  const exportFileDefaultName = `fault-data-${currentTimeRange}d-${new Date().toISOString().split('T')[0]}.json`;
  
  const linkElement = document.createElement('a');
  linkElement.setAttribute('href', dataUri);
  linkElement.setAttribute('download', exportFileDefaultName);
  linkElement.click();
  
  alert(`Chart data exported for ${currentTimeRange} days`);
}

function refreshData() {
  const refreshBtn = event.target.closest('.btn');
  refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
  
  document.getElementById('chartLoading').style.display = 'flex';
  
  setTimeout(() => {
    generateChartData();
    faultChart.data.labels = faultData.labels;
    faultChart.data.datasets[0].data = faultData.critical;
    faultChart.data.datasets[1].data = faultData.warning;
    faultChart.data.datasets[2].data = faultData.normal;
    faultChart.update();
    
    updateChartLegend();
    updateChartStats();
    
    refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
    document.getElementById('chartLoading').style.display = 'none';
    
    alert('Chart data refreshed successfully!');
  }, 800);
}

function openSettings() {
  alert('Chart Settings:\n\n• Time Range: ' + currentTimeRange + ' days\n• Chart Type: ' + chartType + '\n\nFull settings panel would open here.');
}
</script>

</body>
</html>
